<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>HTORI ERP</title>

<style>
body{margin:0;font-family:Arial}
#loginBox{position:fixed;inset:0;display:flex;align-items:center;justify-content:center}
.login-card{border:1px solid #ccc;padding:30px;width:360px;text-align:center}
#erp{display:none}
.sidebar{position:fixed;top:0;left:0;width:180px;height:100vh;background:#222;color:#fff}
.sidebar div{padding:14px;cursor:pointer}
.sidebar div:hover{background:#444}
.content{margin-left:180px;padding:20px}
h2{font-size:22px}
table{width:100%;border-collapse:collapse;margin-top:10px;font-size:14px}
th,td{border:1px solid #ccc;padding:6px}
button.small{font-size:12px;padding:2px 6px}
input,select,button{font-size:14px;padding:4px}
</style>
</head>

<body>

<div id="loginBox">
  <div class="login-card">
    <h2>HTORI ERP LOGIN</h2>
    <input id="loginId" placeholder="admin">
    <input id="loginPw" type="password" placeholder="1234">
    <button onclick="login()">Login</button>
  </div>
</div>

<div id="erp">
  <div class="sidebar">
    <div onclick="page('stock')">Stock</div>
    <div onclick="page('purchase')">Purchase</div>
    <div onclick="logout()">Logout</div>
  </div>
  <div class="content" id="content"></div>
</div>

<script>
/* LOGIN */
function login(){
  if(loginId.value==="admin"&&loginPw.value==="1234"){
    localStorage.setItem("login","Y");
    loginBox.style.display="none";erp.style.display="block";page("stock");
  }
}
function logout(){localStorage.removeItem("login");location.reload()}
if(localStorage.getItem("login")==="Y"){loginBox.style.display="none";erp.style.display="block"}

/* STORAGE */
const getP=()=>JSON.parse(localStorage.getItem("purchase")||"[]");
const saveP=d=>localStorage.setItem("purchase",JSON.stringify(d));

/* STOCK = 집계 */
function page(p){
  if(p==="stock"){
    const map={};
    getP().forEach(i=>{
      if(!map[i.code])map[i.code]={name:i.name,qty:0};
      map[i.code].qty+=i.qty;
    });
    content.innerHTML=`
      <h2>Stock (Read Only)</h2>
      <table><tr><th>Code</th><th>Name</th><th>Qty</th></tr>
      ${Object.keys(map).map(c=>`
        <tr><td>${c}</td><td>${map[c].name}</td><td>${map[c].qty}</td></tr>`).join("")}
      </table>`;
  }

  if(p==="purchase"){
    content.innerHTML=`
      <h2>Purchase</h2>
      <input type="date" id="d">
      <select id="t"><option>Container</option><option>Air</option></select>
      <input id="c" placeholder="Code">
      <input id="n" placeholder="Name">
      <input id="q" type="number" placeholder="Qty">
      <button onclick="add()">Add</button>

      <table>
        <tr><th>Date</th><th>Type</th><th>Code</th><th>Name</th><th>Qty</th><th>Action</th></tr>
        ${getP().map((i,idx)=>`
          <tr>
            <td>${i.date}</td><td>${i.type}</td><td>${i.code}</td><td>${i.name}</td><td>${i.qty}</td>
            <td>
              <button class="small" onclick="edit(${idx})">Edit</button>
              <button class="small" onclick="del(${idx})">Del</button>
            </td>
          </tr>`).join("")}
      </table>`;
    d.value=new Date().toISOString().slice(0,10);
  }
}

function add(){
  const p=getP();
  p.push({date:d.value,type:t.value,code:c.value,name:n.value,qty:Number(q.value)});
  saveP(p);page("purchase");
}

function edit(i){
  const p=getP();const x=p[i];
  d.value=x.date;t.value=x.type;c.value=x.code;n.value=x.name;q.value=x.qty;
  p.splice(i,1);saveP(p);page("purchase");
}
function del(i){const p=getP();p.splice(i,1);saveP(p);page("purchase")}
</script>
<script>
/* ===============================
   HTORI CORE CONTROL LOGIC
   (통제형 ERP 핵심)
================================ */

// 1️⃣ 권한 체크
function canEdit(){
  return ["manager","owner"].includes(currentUser?.role);
}

function canDelete(){
  return ["owner"].includes(currentUser?.role);
}

// 2️⃣ 월마감 체크
function isMonthClosed(date){
  if(!date) return false;
  const month = date.slice(0,7);
  return window.closedMonths?.includes(month);
}

// 3️⃣ BOM 변경 + LOG
function updateBOM(productCode, newBom){
  if(!canEdit()) return alert("권한 없음");

  const ref = db.ref("bom").child(productCode);

  ref.once("value").then(snap=>{
    const oldBom = snap.val();

    db.ref("bom_log").push({
      productCode,
      before: oldBom,
      after: newBom,
      changedBy: currentUser.id,
      changedAt: new Date().toISOString()
    });

    ref.set(newBom);
    alert("BOM 변경 완료 (전체 적용)");
  });
}

// 4️⃣ 공정 처리 (재고 차감 → 신규 코드 생성)
function processProduction({ inputCode, processCode, outputCode, qty }){
  if(!canEdit()) return alert("권한 없음");
  if(qty <= 0) return alert("수량 오류");

  // 입력 코드 차감
  db.ref("materials").orderByChild("code").equalTo(inputCode)
    .once("value").then(snap=>{
      if(!snap.exists()) return alert("입력 코드 없음");

      const key = Object.keys(snap.val())[0];
      const mat = snap.val()[key];

      if(mat.qty < qty) return alert("재고 부족");

      db.ref(`materials/${key}/qty`).set(mat.qty - qty);
    });

  // 공정 로그
  db.ref("process_log").push({
    inputCode,
    processCode,
    outputCode,
    qty,
    worker: currentUser.id,
    createdAt: new Date().toISOString()
  });

  // 출력 코드 증가
  db.ref("materials").orderByChild("code").equalTo(outputCode)
    .once("value").then(snap=>{
      if(snap.exists()){
        const k = Object.keys(snap.val())[0];
        const v = snap.val()[k];
        db.ref(`materials/${k}/qty`).set((v.qty||0) + qty);
      }else{
        db.ref("materials").push({
          code: outputCode,
          qty,
          createdAt: new Date().toISOString()
        });
      }
    });

  alert("공정 처리 완료");
}

// 5️⃣ 불량 처리 = 재고 손실
function recordDefect(code, qty, reason){
  if(!canEdit()) return alert("권한 없음");

  db.ref("materials").orderByChild("code").equalTo(code)
    .once("value").then(snap=>{
      if(!snap.exists()) return alert("코드 없음");

      const k = Object.keys(snap.val())[0];
      const v = snap.val()[k];

      if(v.qty < qty) return alert("재고 부족");

      db.ref(`materials/${k}/qty`).set(v.qty - qty);
    });

  db.ref("scrap_log").push({
    code, qty, reason,
    createdBy: currentUser.id,
    createdAt: new Date().toISOString()
  });

  alert("불량 처리 완료");
}
</script>

</body>
</html>
