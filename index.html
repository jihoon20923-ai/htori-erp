<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>HTORI ERP v1 – CORE ENGINE CLEAN</title>

<style>
body{margin:0;font-family:Arial;background:#f4f6f9}
header{background:#1f3c88;color:#fff;padding:12px 20px;font-size:18px}

.layout{display:flex;height:100vh}

/* LEFT MENU */
.sidebar{
  width:220px;
  background:#11151a;
  color:#fff;
  padding:14px;
}
.menu-btn{
  width:100%;padding:10px;margin-bottom:6px;background:#222;border:0;color:#fff;cursor:pointer;text-align:left;border-radius:4px;
}
.menu-btn:hover{background:#333}
.menu-btn.active{background:#1f3c88}

/* RIGHT CONTENT */
.content{
  flex:1;padding:20px;overflow-y:auto;
}
table{border-collapse:collapse;width:100%;background:#fff;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px}
th{background:#eee}
input,select,button{padding:6px;margin:4px;width:200px}
.danger{color:red;cursor:pointer}
</style>

</head>
<body>

<header>HTORI ERP – CORE v1</header>

<div class="layout">

<!-- LEFT MENU -->
<aside class="sidebar">

  <button class="menu-btn active" onclick="showPage('purchase')">Purchase 입고</button>
  <button class="menu-btn" onclick="showPage('production')">Production 공정</button>
  <button class="menu-btn" onclick="showPage('defect')">Defect 불량</button>
  <button class="menu-btn" onclick="showPage('outsource')">Outsource 외주</button>
  <button class="menu-btn" onclick="showPage('stock')">Stock 재고</button>
  <button class="menu-btn" onclick="showPage('movement')">Movement 로그</button>
  <button class="menu-btn" onclick="showPage('employee')">Employees 직원등록</button>

</aside>


<!-- RIGHT CONTENT -->
<main id="content" class="content"></main>

</div>


<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>

firebase.initializeApp({
  apiKey:"AIzaSyARxh0wfAo2RMz_-3KsWUUQYfND_F3_3fI",
  authDomain:"htori-erp-38ed1.firebaseapp.com",
  databaseURL:"https://htori-erp-38ed1-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:"htori-erp-38ed1"
});
const db=firebase.database();


/*=========================================================
 GENERAL PAGE SWITCH
=========================================================*/
function showPage(key){

  document.querySelectorAll(".menu-btn").forEach(b=>b.classList.remove("active"));
  document.querySelector(`button[onclick="showPage('${key}')"]`).classList.add("active");

  if(key==="purchase") return renderPurchase();
  if(key==="production") return renderProduction();
  if(key==="defect") return renderDefect();
  if(key==="outsource") return renderOutsource();
  if(key==="stock") return renderStock();
  if(key==="movement") return renderMovement();
  if(key==="employee") return renderEmployee();
}


/*=========================================================
 FIREBASE MOVEMENT CORE
=========================================================*/
function addMovement(o){
  const ref=db.ref("stock_movement").push();
  ref.set(o).then(()=>recalcStock(o.code));
}

function recalcStock(code){
  db.ref("stock_movement")
    .orderByChild("code").equalTo(code)
    .once("value")
    .then(s=>{
      let qty=0;
      s.forEach(c=>{
        const m=c.val();
        qty += (m.type==="IN"?m.qty:-m.qty);
      });
      db.ref("stock/"+code).set({code,qty});
      renderStock();
    });
}


/*=========================================================
 PURCHASE
=========================================================*/
function renderPurchase(){
content.innerHTML=`
<h2>입고 Purchase</h2>

<input type="date" id="p_date">
<input id="p_code" placeholder="Code">
<input id="p_name" placeholder="Name">
<input type="number" id="p_qty" placeholder="Qty">
<button onclick="savePurchase()">Save</button>

<table>
<thead><tr><th>Date</th><th>Code</th><th>Name</th><th>Qty</th><th></th></tr></thead>
<tbody id="purchaseBody"></tbody>
</table>
`;
loadPurchase();
}

function savePurchase(){
  const date=p_date.value,code=p_code.value,name=p_name.value,qty=+p_qty.value;
  const ref=db.ref("purchase").push();
  ref.set({date,code,name,qty});
  addMovement({date,code,qty,type:"IN",source:"PURCHASE",refId:ref.key});
  loadPurchase();
}

function loadPurchase(){
  db.ref("purchase").once("value").then(s=>{
    purchaseBody.innerHTML="";
    s.forEach(c=>{
      const v=c.val();
      purchaseBody.innerHTML+=`
      <tr>
        <td>${v.date}</td><td>${v.code}</td><td>${v.name}</td><td>${v.qty}</td>
        <td class="danger" onclick="delPurchase('${c.key}','${v.code}')">Del</td>
      </tr>`;
    });
  });
}

function delPurchase(k,code){
  db.ref("purchase/"+k).remove();
  db.ref("stock_movement")
    .orderByChild("refId").equalTo(k)
    .once("value").then(s=>{
      s.forEach(c=>c.ref.remove());
      recalcStock(code);
      loadPurchase();
    });
}


/*=========================================================
 PRODUCTION
=========================================================*/
function renderProduction(){
content.innerHTML=`
<h2>Production 공정</h2>

<input id="prod_in" placeholder="소모 Code">
<input id="prod_out" placeholder="생성 Code">
<input type="number" id="prod_qty" placeholder="Qty">
<button onclick="saveProduction()">Run</button>
`;
}

function saveProduction(){
  addMovement({code:prod_in.value,qty:+prod_qty.value,type:"OUT",source:"PRODUCTION"});
  addMovement({code:prod_out.value,qty:+prod_qty.value,type:"IN",source:"PRODUCTION"});
}


/*=========================================================
 DEFECT
=========================================================*/
function renderDefect(){
content.innerHTML=`
<h2>불량 처리</h2>
<input id="def_code" placeholder="Code">
<input type="number" id="def_qty" placeholder="Qty">
<button onclick="saveDefect()">Save</button>
`;
}
function saveDefect(){
  addMovement({code:def_code.value,qty:+def_qty.value,type:"OUT",source:"DEFECT"});
}


/*=========================================================
 OUTSOURCE
=========================================================*/
function renderOutsource(){
content.innerHTML=`
<h2>외주 입/출</h2>

<select id="os_type">
<option value="OUT">Send</option>
<option value="IN">Receive</option>
</select>
<input id="os_vendor" placeholder="Vendor">
<input id="os_code" placeholder="Code">
<input type="number" id="os_qty" placeholder="Qty">
<button onclick="saveOutsource()">Save</button>
`;
}
function saveOutsource(){
  addMovement({
    code:os_code.value,
    qty:+os_qty.value,
    type:os_type.value==="OUT"?"OUT":"IN",
    source:"OUTSOURCE",
    vendor:os_vendor.value
  });
}


/*=========================================================
 STOCK
=========================================================*/
function renderStock(){
content.innerHTML=`
<h2>재고 Stock</h2>
<table>
<thead><tr><th style="width:120px">Code</th><th>Qty</th></tr></thead>
<tbody id="stockBody"></tbody>
</table>
`;
loadStock();
}

function loadStock(){
  db.ref("stock").once("value").then(s=>{
    stockBody.innerHTML="";
    s.forEach(c=>{
      const v=c.val();
      stockBody.innerHTML+=`
      <tr><td>${v.code}</td><td>${v.qty}</td></tr>`;
    });
  });
}


/*=========================================================
 MOVEMENT
=========================================================*/
function renderMovement(){
content.innerHTML=`
<h2>Movement 로그</h2>
<table>
<thead><tr><th>Date</th><th>Code</th><th>Qty</th><th>Type</th><th>Source</th><th>Vendor</th></tr></thead>
<tbody id="movementBody"></tbody>
</table>`;
loadMovement();
}

function loadMovement(){
  db.ref("stock_movement").limitToLast(200).once("value").then(s=>{
    movementBody.innerHTML="";
    s.forEach(c=>{
      const m=c.val();
      movementBody.innerHTML+=`
      <tr>
        <td>${m.date||""}</td>
        <td>${m.code}</td>
        <td>${m.qty}</td>
        <td>${m.type}</td>
        <td>${m.source}</td>
        <td>${m.vendor||""}</td>
      </tr>`;
    });
  });
}


/*=========================================================
 EMPLOYEE 등록 (종교 포함)
=========================================================*/
function renderEmployee(){
content.innerHTML=`

<h2>직원 등록</h2>

<input id="emp_id" placeholder="Employee ID">
<input id="emp_name" placeholder="Name">
<input id="emp_phone" placeholder="Phone">
<input id="emp_address" placeholder="Address">
<input id="emp_religion" placeholder="Religion (종교)">
<button onclick="saveEmployee()">Save</button>

<table>
<thead><tr><th>ID</th><th>Name</th><th>Phone</th><th>Address</th><th>Religion</th></tr></thead>
<tbody id="empBody"></tbody>
</table>

`;
loadEmployee();
}

function saveEmployee(){
  db.ref("employees").push({
    id:emp_id.value,
    name:emp_name.value,
    phone:emp_phone.value,
    address:emp_address.value,
    religion:emp_religion.value
  }).then(()=>loadEmployee());
}

function loadEmployee(){
  db.ref("employees").once("value").then(s=>{
    empBody.innerHTML="";
    s.forEach(c=>{
      const v=c.val();
      empBody.innerHTML+=`
      <tr>
        <td>${v.id}</td>
        <td>${v.name}</td>
        <td>${v.phone}</td>
        <td>${v.address}</td>
        <td>${v.religion}</td>
      </tr>`;
    });
  });
}


showPage("purchase");

</script>

</body>
</html>
