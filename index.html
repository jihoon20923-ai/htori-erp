<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>HTORI ERP – STOCK CORE EXPANDED</title>

<style>
body{font-family:Arial;margin:0;background:#f5f6f9;}
header{background:#1f3c88;color:#fff;padding:12px 18px;font-size:19px}
.container{display:flex}
.sidebar{width:200px;background:#111;color:#fff;min-height:100vh;padding-top:20px}
.sidebar button{display:block;width:100%;padding:10px;margin:4px 0;background:#222;color:white;border:none;text-align:left}
.main{flex:1;padding:22px}

/* 공통 UI */
h2{margin-top:25px;margin-bottom:8px}
input,select,button{padding:6px;margin:4px}
table{border-collapse:collapse;width:100%;background:white;margin-top:12px}
th,td{border:1px solid #ccc;padding:6px}
th{background:#eee}
.danger{color:red;cursor:pointer}
</style>
</head>

<body>

<header>HTORI ERP – STOCK + BOM + PROCESS + VENDOR</header>

<div class="container">

<!-- SIDE MENU -->
<div class="sidebar">
 <button onclick="showPage('purchase')">입고</button>
 <button onclick="showPage('production')">생산</button>
 <button onclick="showPage('defect')">불량</button>
 <button onclick="showPage('outsource')">외주</button>
 <button onclick="showPage('stock')">재고</button>
 <button onclick="showPage('bom')">BOM</button>
 <button onclick="showPage('process')">공정관리</button>
 <button onclick="showPage('vendor')">벤더관리</button>
</div>

<div class="main">

<!-- PURCHASE -->
<section id="purchase" class="page">
<h2>입고</h2>
<input type="date" id="p_date">
<input id="p_code" placeholder="Code">
<input id="p_name" placeholder="Name">
<input type="number" id="p_qty" placeholder="Qty">
<button onclick="savePurchase()">Save</button>

<table>
<thead><tr><th>Date</th><th>Code</th><th>Name</th><th>Qty</th></tr></thead>
<tbody id="purchaseBody"></tbody>
</table>
</section>


<!-- PRODUCTION -->
<section id="production" class="page" style="display:none">
<h2>생산</h2>
<select id="prod_process"></select>
<input id="prod_out" placeholder="Output Code">
<input id="prod_qty" type="number">
<button onclick="runProd()">Run Production</button>
</section>


<!-- DEFECT -->
<section id="defect" class="page" style="display:none">
<h2>불량</h2>
<input id="def_code" placeholder="Code">
<input type="number" id="def_qty" placeholder="Qty">
<input id="def_reason" placeholder="사유">
<button onclick="runDefect()">등록</button>
</section>


<!-- OUTSOURCE -->
<section id="outsource" class="page" style="display:none">
<h2>외주</h2>
<select id="os_type">
 <option value="OUT">OUT</option>
 <option value="IN">IN</option>
</select>
<select id="os_vendor"></select>
<input id="os_code" placeholder="Code">
<input type="number" id="os_qty" placeholder="Qty">
<button onclick="runOutsource()">Save</button>
</section>


<!-- STOCK -->
<section id="stock" class="page" style="display:none">
<h2>재고</h2>
<button onclick="recalcStock()">재계산</button>

<table>
<thead><tr><th>Code</th><th>Name</th><th>Qty</th></tr></thead>
<tbody id="stockBody"></tbody>
</table>
</section>


<!-- BOM -->
<section id="bom" class="page" style="display:none">
<h2>BOM</h2>
<input id="bom_parent" placeholder="Parent Code">
<input id="bom_child" placeholder="Child Code">
<input id="bom_qty" type="number" placeholder="Qty per unit">
<button onclick="saveBOM()">저장</button>

<table>
<thead><tr><th>Parent</th><th>Child</th><th>Child Name</th><th>Qty</th></tr></thead>
<tbody id="bomBody"></tbody>
</table>
</section>


<!-- PROCESS -->
<section id="process" class="page" style="display:none">
<h2>공정 관리</h2>
<input id="proc_id" placeholder="공정코드">
<input id="proc_name" placeholder="공정명">
<button onclick="saveProcess()">저장</button>

<table>
<thead><tr><th>ID</th><th>공정명</th></tr></thead>
<tbody id="procBody"></tbody>
</table>
</section>


<!-- VENDOR -->
<section id="vendor" class="page" style="display:none">
<h2>벤더 관리</h2>
<input id="v_name" placeholder="Vendor">
<input id="v_phone" placeholder="Phone">
<input id="v_addr" placeholder="Address">
<button onclick="saveVendor()">저장</button>

<table>
<thead><tr><th>Name</th><th>Phone</th><th>Address</th></tr></thead>
<tbody id="vendorBody"></tbody>
</table>
</section>


</div>
</div>




<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
// firebase init
firebase.initializeApp({
 apiKey:"AIzaSyARxh0wfAo2RMz_-3KsWUUQYfND_F3_3fI",
 authDomain:"htori-erp-38ed1.firebaseapp.com",
 databaseURL:"https://htori-erp-38ed1-default-rtdb.asia-southeast1.firebasedatabase.app",
 projectId:"htori-erp-38ed1"
});
const db=firebase.database()

function showPage(p){
 document.querySelectorAll(".page").forEach(e=>e.style.display="none")
 document.getElementById(p).style.display="block"
}

/* movement push */
function addMove(obj){
 db.ref("stock_movement").push(obj)
}

/* PURCHASE */
function savePurchase(){
 addMove({date:p_date.value,code:p_code.value,name:p_name.value,qty:+p_qty.value,type:"IN",src:"PURCHASE"})
 loadPurchase()
}

function loadPurchase(){
 purchaseBody.innerHTML=""
 db.ref("stock_movement").orderByChild("src").equalTo("PURCHASE").once("value",s=>{
  s.forEach(c=>{
   let v=c.val()
   purchaseBody.innerHTML+=`<tr><td>${v.date}</td><td>${v.code}</td><td>${v.name}</td><td>${v.qty}</td></tr>`
  })
 })
}

/* BOM */
function saveBOM(){
 let code=bom_child.value
 db.ref("stock").child(code).once("value").then(s=>{
   let name=s.val()?.name || ""
   db.ref("bom").push({parent:bom_parent.value,child:code,childName:name,qty:+bom_qty.value})
   loadBOM()
 })
}

function loadBOM(){
 bomBody.innerHTML=""
 db.ref("bom").once("value",s=>{
   s.forEach(c=>{
     let b=c.val()
     bomBody.innerHTML+=`<tr><td>${b.parent}</td><td>${b.child}</td><td>${b.childName}</td><td>${b.qty}</td></tr>`
   })
 })
}


/* PROCESS */
function saveProcess(){
 db.ref("process").push({id:proc_id.value,name:proc_name.value})
 loadProcess()
}
function loadProcess(){
 procBody.innerHTML=""
 prod_process.innerHTML=""
 db.ref("process").once("value",s=>{
   s.forEach(c=>{
    let p=c.val()
    prod_process.innerHTML+=`<option value="${p.id}">${p.id} - ${p.name}</option>`
    procBody.innerHTML+=`<tr><td>${p.id}</td><td>${p.name}</td></tr>`
   })
 })
}


/* Vendor */
function saveVendor(){
 db.ref("vendors").push({name:v_name.value,phone:v_phone.value,addr:v_addr.value})
 loadVendor()
}

function loadVendor(){
 vendorBody.innerHTML=""
 os_vendor.innerHTML=""
 db.ref("vendors").once("value",s=>{
  s.forEach(c=>{
    let v=c.val()
    vendorBody.innerHTML+=`<tr><td>${v.name}</td><td>${v.phone}</td><td>${v.addr}</td></tr>`
    os_vendor.innerHTML+=`<option>${v.name}</option>`
  })
 })
}


/* Production (BOM 자동소모) */
function runProd(){
 let qty=+prod_qty.value
 let out=prod_out.value
 
 addMove({code:out,qty,type:"IN",src:"PROD"})

 db.ref("bom").orderByChild("parent").equalTo(out).once("value").then(s=>{
  s.forEach(c=>{
    let b=c.val()
    addMove({code:b.child,qty:(b.qty*qty),type:"OUT",src:"BOM"})
  })
 })
 alert("완료")
}


/* Defect */
function runDefect(){
 addMove({code:def_code.value,qty:+def_qty.value,type:"OUT",src:"DEFECT",reason:def_reason.value})
}


/* Outsource */
function runOutsource(){
 addMove({code:os_code.value,qty:+os_qty.value,type:os_type.value,src:"OUTSRC",vendor:os_vendor.value})
}


/* 재고 계산 */
function recalcStock(){
 let map={}
 db.ref("stock_movement").once("value").then(s=>{
  s.forEach(c=>{
   let m=c.val()
   if(!map[m.code])map[m.code]={code:m.code,name:m.name||"",qty:0}
   if(m.type==="IN")map[m.code].qty+=m.qty
   if(m.type==="OUT")map[m.code].qty-=m.qty
  })
  db.ref("stock").set(map)
  loadStock()
 })
}

function loadStock(){
 stockBody.innerHTML=""
 db.ref("stock").once("value",s=>{
  s.forEach(c=>{
    let v=c.val()
    stockBody.innerHTML+=`<tr><td>${v.code}</td><td>${v.name}</td><td>${v.qty}</td></tr>`
  })
 })
}

/* INIT */
loadPurchase()
loadStock()
loadBOM()
loadProcess()
loadVendor()

</script>

</body>
</html>
