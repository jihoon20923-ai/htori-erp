<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>HTORI ERP - STOCK STEP 1</title>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
body { font-family: Arial; padding:20px; }
input, button { width:100%; margin:4px 0; padding:6px; }
table { width:100%; border-collapse:collapse; margin-top:10px; }
th, td { border:1px solid #ccc; padding:6px; }
</style>
</head>

<body>

<h2>Purchase (입고)</h2>

<input type="date" id="p_date">
<input placeholder="Code (ex: A12)" id="p_code">
<input placeholder="Name" id="p_name">
<input placeholder="Qty" id="p_qty">

<button onclick="savePurchase()">Save Purchase</button>
<button onclick="loginMaster()">Login Master</button>

<h2>Stock</h2>
<table>
<thead>
<tr><th>Code</th><th>Name</th><th>Qty</th><th>Action</th></tr>
</thead>
<tbody id="stockBody"></tbody>
</table>

<h2>Purchase History</h2>
<button onclick="downloadPurchaseExcel()">Download Excel</button>
<table>
<thead>
<tr><th>Date</th><th>Code</th><th>Name</th><th>Qty</th><th>Action</th></tr>
</thead>
<tbody id="purchaseBody"></tbody>
</table>
<h2>Defect (불량)</h2>

<input type="date" id="d_date">
<input placeholder="Code (ex: A12)" id="d_code">
<input placeholder="Qty (불량수량)" id="d_qty">
<input placeholder="Reason (optional)" id="d_reason">

<button onclick="saveDefect()">Save Defect</button>

<table>
<thead>
<tr><th>Date</th><th>Code</th><th>Qty</th><th>Reason</th><th>Action</th></tr>
</thead>
<tbody id="defectBody"></tbody>
</table>
  
/* ===== DEFECT 저장 + Stock 차감 ===== */
function saveDefect(){
  const date = d_date.value;
  const code = d_code.value.trim();
  const qty  = Number(d_qty.value);
  const reason = d_reason.value || "";

  if(!date || !code || !qty){
    alert("Date / Code / Qty required");
    return;
  }

  const stockRef = db.ref("stock/" + code);

  stockRef.once("value").then(snap=>{
    if(!snap.exists()){
      alert("Stock not found");
      return;
    }

    const current = snap.val().qty;
    if(current < qty){
      alert("Not enough stock");
      return;
    }

    /* 1. 불량 저장 */
    db.ref("defect").push({date, code, qty, reason});

    /* 2. 재고 차감 */
    stockRef.update({ qty: current - qty });

    alert("Defect Saved");
    showStock();
    showDefect();
  });
}

/* ===== DEFECT 조회 ===== */
function showDefect(){
  const body = document.getElementById("defectBody");
  body.innerHTML = "";

  db.ref("defect").once("value").then(snap=>{
    snap.forEach(c=>{
      const d = c.val();
      let btn = isMaster ? `<button onclick="deleteDefect('${c.key}')">Del</button>` : "";
      body.innerHTML += `
        <tr>
          <td>${d.date}</td>
          <td>${d.code}</td>
          <td>${d.qty}</td>
          <td>${d.reason || ""}</td>
          <td>${btn}</td>
        </tr>`;
    });
  });
}

/* ===== DEFECT 삭제 (Master) ===== */
function deleteDefect(key){
  if(confirm("Delete defect?")){
    db.ref("defect/"+key).remove();
    showDefect();
  }
}

<script>
/* ===== Firebase 설정 (38ed1) ===== */
const firebaseConfig = {
  apiKey: "AIzaSyDwiTlPtoXraEtA7TzTctdH6DJS6gdSEGQ",
  databaseURL: "https://htori-erp-38ed1-default-rtdb.asia-southeast1.firebasedatabase.app"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let isMaster = false;

/* ===== Purchase 저장 + Stock 누적 ===== */
function savePurchase(){
  const date = p_date.value;
  const code = p_code.value.trim();
  const name = p_name.value.trim();
  const qty  = Number(p_qty.value);

  if(!date || !code || !qty){
    alert("Date / Code / Qty required");
    return;
  }

  db.ref("purchase").push({date, code, name, qty});

  const stockRef = db.ref("stock/" + code);
  stockRef.once("value").then(snap=>{
    let current = 0;
    if(snap.exists()) current = snap.val().qty;
    stockRef.set({code, name, qty: current + qty});
  });

  alert("Saved");
  showPurchase();
  showStock();
}

/* ===== Stock 조회 ===== */
function showStock(){
  const body = document.getElementById("stockBody");
  body.innerHTML = "";
  db.ref("stock").once("value").then(snap=>{
    snap.forEach(c=>{
      const s = c.val();
      let btn = isMaster ? `<button onclick="deleteStock('${c.key}')">Del</button>` : "";
      body.innerHTML += `<tr><td>${s.code}</td><td>${s.name}</td><td>${s.qty}</td><td>${btn}</td></tr>`;
    });
  });
}

/* ===== Purchase 조회 ===== */
function showPurchase(){
  const body = document.getElementById("purchaseBody");
  body.innerHTML = "";
  db.ref("purchase").once("value").then(snap=>{
    snap.forEach(c=>{
      const p = c.val();
      let btn = isMaster ? `<button onclick="deletePurchase('${c.key}')">Del</button>` : "";
      body.innerHTML += `<tr>
        <td>${p.date}</td>
        <td>${p.code}</td>
        <td>${p.name}</td>
        <td>${p.qty}</td>
        <td>${btn}</td>
      </tr>`;
    });
  });
}

/* ===== 삭제 ===== */
function deletePurchase(k){
  if(confirm("Delete?")){
    db.ref("purchase/"+k).remove();
    showPurchase();
  }
}
function deleteStock(k){
  if(confirm("Delete stock?")){
    db.ref("stock/"+k).remove();
    showStock();
  }
}

/* ===== Master ===== */
function loginMaster(){
  const pw = prompt("Master password");
  if(pw === "1234"){
    isMaster = true;
    alert("Master ON");
    showStock();
    showPurchase();
  }
}

/* ===== Excel ===== */
function downloadPurchaseExcel(){
  db.ref("purchase").once("value").then(snap=>{
    const rows = [["Date","Code","Name","Qty"]];
    snap.forEach(c=>{
      const p = c.val();
      rows.push([p.date,p.code,p.name,p.qty]);
    });
    const wb = XLSX.utils.book_new();
    const ws = XLSX.utils.aoa_to_sheet(rows);
    XLSX.utils.book_append_sheet(wb, ws, "Purchase");
    XLSX.writeFile(wb, "purchase.xlsx");
  });
}

/* ===== 최초 로드 ===== */
showStock();
showPurchase();
showDefect();   // ← 이 줄 추가

</script>

</body>
</html>
