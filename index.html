<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>HTORI ERP CORE FULL A-1</title>

<style>
body{font-family:Arial;background:#f4f6f9;margin:0;display:flex}
.sidebar{width:220px;background:#1f3c88;color:#fff;height:100vh;padding:14px;box-sizing:border-box}
.sidebar button{width:100%;background:transparent;border:0;color:#fff;text-align:left;padding:10px;margin-bottom:6px;cursor:pointer;font-size:15px}
.sidebar button.active{background:#162b5c}
.main{flex:1;padding:20px;overflow:auto;height:100vh;box-sizing:border-box;}

h2{margin-top:30px}
input,select,button{padding:6px;margin:4px}
table{border-collapse:collapse;width:100%;background:#fff;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px}
th{background:#eee}
.danger{color:red;cursor:pointer}
</style>
</head>

<body>

<!-- LEFT MENU -->
<div class="sidebar">
  <button onclick="showPage('purchase')" id="m_purchase">Purchase</button>
  <button onclick="showPage('production')" id="m_prod">Production</button>
  <button onclick="showPage('defect')" id="m_defect">Defect</button>
  <button onclick="showPage('outsource')" id="m_out">Outsource</button>
  <button onclick="showPage('stock')" id="m_stock">Stock</button>
</div>

<div class="main" id="page"></div>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
//==========================================
// FIREBASE INIT
//==========================================
// Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyARxh0wfAo2RMz_-3KsWUUQYfND_F3_3fI",
  authDomain: "htori-erp-38ed1.firebaseapp.com",
  databaseURL: "https://htori-erp-38ed1-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "htori-erp-38ed1",
  storageBucket: "htori-erp-38ed1.firebasestorage.app",
  messagingSenderId: "653618187246",
  appId: "1:653618187246:web:cfdf888e1bbb3106cedcff",
  measurementId: "G-Z3J1NW0KQE"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);

//==========================================
// PAGE NAV
//==========================================
function clearActive(){
  document.querySelectorAll(".sidebar button").forEach(b=>b.classList.remove("active"));
}
function showPage(pg){
  clearActive();
  document.getElementById("m_"+pg).classList.add("active");
  if(pg==="purchase") renderPurchase();
  if(pg==="production") renderProduction();
  if(pg==="defect") renderDefect();
  if(pg==="out") renderOut();
  if(pg==="outsource") renderOutsource();
  if(pg==="stock") renderStock();
}

//==========================================
// CORE MOVEMENT ADDER
//==========================================
function addMovement(obj){
  db.ref("stock_movement").push(obj).then(()=>recalcStock(obj.code));
}

// calc selected code stock
function recalcStock(code){
  db.ref("stock_movement").orderByChild("code").equalTo(code).once("value").then(snap=>{
    let qty=0,name="";
    snap.forEach(c=>{
      const m=c.val();
      name=m.name||name;
      qty += (m.type==="IN"?m.qty:-m.qty);
    });
    db.ref("stock/"+code).set({code,name,qty});
    renderStock();
  });
}

//==========================================
// PURCHASE
//==========================================
function renderPurchase(){
  page.innerHTML=`
  <h2>Purchase</h2>
  <input type="date" id="p_date">
  <input id="p_code" placeholder="Code">
  <input id="p_name" placeholder="Name">
  <input type="number" id="p_qty" placeholder="Qty">
  <button onclick="savePurchase()">Save</button>

  <table>
    <thead><tr><th>Date</th><th>Code</th><th>Name</th><th>Qty</th><th></th></tr></thead>
    <tbody id="purchaseBody"></tbody>
  </table>
  `;
  loadPurchase();
}

function savePurchase(){
  const date=p_date.value,code=p_code.value,name=p_name.value,qty=+p_qty.value;
  const ref=db.ref("purchase").push();
  ref.set({date,code,name,qty});
  addMovement({date,code,name,qty,type:"IN",source:"PURCHASE",refId:ref.key});
  loadPurchase();
}

function loadPurchase(){
  purchaseBody.innerHTML="";
  db.ref("purchase").once("value").then(s=>{
    s.forEach(c=>{
      const p=c.val();
      purchaseBody.innerHTML+=`
      <tr>
        <td>${p.date}</td>
        <td>${p.code}</td>
        <td>${p.name}</td>
        <td>${p.qty}</td>
        <td class="danger" onclick="delPurchase('${c.key}','${p.code}')">DELETE</td>
      </tr>`;
    });
  });
}

function delPurchase(k,code){
  db.ref("purchase/"+k).remove();
  db.ref("stock_movement").orderByChild("refId").equalTo(k).once("value").then(s=>{
    s.forEach(c=>c.ref.remove());
    recalcStock(code);
    loadPurchase();
  });
}

//==========================================
// PRODUCTION
//==========================================
function renderProduction(){
  page.innerHTML=`
  <h2>Production</h2>
  <select id="proc"><option>P01</option><option>P02</option></select>
  <input id="prod_in" placeholder="Input Code">
  <input id="prod_out" placeholder="Output Code">
  <input type="number" id="prod_qty" placeholder="Qty">
  <button onclick="saveProduction()">RUN</button>
  `;
}

function saveProduction(){
  const p=proc.value,inC=prod_in.value,outC=prod_out.value,qty=+prod_qty.value;
  addMovement({code:inC,qty,type:"OUT",source:"PRODUCTION",proc:p});
  addMovement({code:outC,qty,type:"IN",source:"PRODUCTION",proc:p});
}

//==========================================
// DEFECT
//==========================================
function renderDefect(){
  page.innerHTML=`
  <h2>Defect</h2>
  <input id="def_code" placeholder="Code">
  <input type="number" id="def_qty" placeholder="Qty">
  <input id="def_memo" placeholder="Reason / Memo">
  <button onclick="saveDefect()">DEFECT</button>
  `;
}
function saveDefect(){
  addMovement({code:def_code.value,qty:+def_qty.value,type:"OUT",source:"DEFECT",memo:def_memo.value});
}

//==========================================
// OUTSOURCE
//==========================================
function renderOutsource(){
  page.innerHTML=`
  <h2>Outsource</h2>
  <select id="os_type"><option value="OUT">Send</option><option value="IN">Receive</option></select>
  <input id="os_vendor" placeholder="Vendor">
  <input id="os_code" placeholder="Code">
  <input type="number" id="os_qty" placeholder="Qty">
  <button onclick="saveOutsource()">SAVE</button>
  `;
}
function saveOutsource(){
  addMovement({
    code:os_code.value,
    qty:+os_qty.value,
    type:os_type.value,
    source:"OUTSOURCE",
    vendor:os_vendor.value
  });
}

//==========================================
// STOCK
//==========================================
function renderStock(){
  page.innerHTML=`
  <h2>Stock</h2>
  <table>
    <thead><tr><th>Code</th><th>Name</th><th>Qty</th></tr></thead>
    <tbody id="stockBody"></tbody>
  </table>
  `;
  loadStock();
}

function loadStock(){
  stockBody.innerHTML="";
  db.ref("stock").once("value").then(s=>{
    s.forEach(c=>{
      const v=c.val();
      stockBody.innerHTML+=`
      <tr>
        <td>${v.code}</td>
        <td>${v.name||""}</td>
        <td>${v.qty}</td>
      </tr>`;
    });
  });
}

// 시작
showPage("purchase");
</script>

</body>
</html>
