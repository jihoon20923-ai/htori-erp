<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<title>HTORI ERP - STOCK</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
body{margin:0;font-family:Arial;background:#f5f6f8}
header{background:#1f3c88;color:#fff;padding:14px 20px;font-size:18px}
.wrap{display:flex}
aside{width:180px;background:#111;color:#fff;min-height:100vh;padding:10px}
aside button{width:100%;margin-bottom:8px;padding:10px;background:#222;color:#fff;border:0;cursor:pointer}
main{flex:1;padding:20px}
.card{background:#fff;padding:16px;border-radius:6px;max-width:560px}
label{display:block;margin-top:10px;font-weight:bold}
input,select,button{width:100%;padding:8px;margin-top:4px}
table{margin-top:20px;width:100%;border-collapse:collapse;background:#fff}
th,td{border:1px solid #ddd;padding:8px}
.small{font-size:12px;color:#666}
</style>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>

<body>
<header>HTORI ERP · STOCK</header>

<div class="wrap">
  <aside>
    <button onclick="showPurchase()">Purchase</button>
    <button onclick="showStock()">Stock</button>
    <button onclick="showDefect()">Defect</button>
    <button onclick="loginMaster()">Login Master</button>
  </aside>
  <main id="content"></main>
</div>

<script>
/* ================= Firebase ================= */
firebase.initializeApp({
  apiKey: "YOUR_API_KEY",
  authDomain: "htori-erp-38ed1.firebaseapp.com",
  databaseURL: "https://htori-erp-38ed1-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "htori-erp-38ed1"
});
const db = firebase.database();

/* ================= STATE ================= */
let isMaster = false;

/* ================= LOGIN ================= */
function loginMaster(){
  const pw = prompt("Master Password?");
  if(pw === "1234"){
    isMaster = true;
    alert("Master Mode ON");
    showStock();
  } else {
    alert("Wrong password");
  }
}

/* ================= PURCHASE ================= */
function showPurchase(){
  content.innerHTML = `
  <h2>Purchase (입고)</h2>
  <div class="card">
    <label>Date</label>
    <input id="p_date" type="date" value="${new Date().toISOString().slice(0,10)}">

    <label>Code</label>
    <input id="p_code">

    <label>Name</label>
    <input id="p_name">

    <label>Qty</label>
    <input id="p_qty" type="number">

    <label>Unit Price</label>
    <input id="p_price" type="number" step="0.0001">

    <label>Currency</label>
    <select id="p_cur">
      <option>USD</option>
      <option>IDR</option>
    </select>

    <button onclick="savePurchase()">Save</button>
  </div>`;
}

function savePurchase(){
  const d=p_date.value,c=p_code.value.trim(),n=p_name.value.trim();
  const q=+p_qty.value,p=+p_price.value,cur=p_cur.value;
  if(!c||!q) return alert("Code / Qty required");

  db.ref("purchase").push({
    date:d,code:c,name:n,qty:q,price:p,currency:cur,total:q*p
  });

  db.ref("stock").orderByChild("code").equalTo(c).once("value").then(snap=>{
  if(snap.exists()){
    const key = Object.keys(snap.val())[0];
    const cur = snap.val()[key];
    db.ref("stock/"+key).update({
      qty: cur.qty + q,
      name: n || cur.name
    });
  } else {
    db.ref("stock").push({
      code: c,
      name: n,
      qty: q
    });
  }
});


  alert("Saved");
}
<h3>Purchase History</h3>
<button onclick="downloadPurchase()">Download CSV</button>
<table>
<thead>
<tr><th>Date</th><th>Code</th><th>Name</th><th>Qty</th><th>Price</th><th>Total</th></tr>
</thead>
<tbody id="purchaseList"></tbody>
</table>

/* ================= STOCK ================= */
function showStock(){
  content.innerHTML = `
  <h2>Stock</h2>
  <table>
    <thead>
      <tr>
        <th>Code</th><th>Name</th><th>Qty</th>
        ${isMaster?'<th>Action</th>':''}
      </tr>
    </thead>
    <tbody id="stockBody"></tbody>
  </table>`;
  loadStock();
}

function loadStock(){
  db.ref("stock").once("value").then(s=>{
    const body=stockBody; body.innerHTML="";
    Object.values(s.val()||{}).forEach(r=>{
      body.innerHTML+=`
      <tr>
        <td>${r.code}</td>
        <td>${r.name}</td>
        <td>${r.qty}</td>
        ${isMaster?`
        <td>
          <button onclick="editStock('${r.code}',${r.qty})">Edit</button>
          <button onclick="delStock('${r.code}')">Del</button>
        </td>`:""}
      </tr>`;
    });
  });
}

function editStock(code){
  db.ref("stock").orderByChild("code").equalTo(code).once("value").then(s=>{
    const key = Object.keys(s.val())[0];
    const cur = s.val()[key];
    const n = prompt("New Qty", cur.qty);
    if(n!==null){
      db.ref("stock/"+key+"/qty").set(+n);
    }
  });
}

function delStock(code){
  if(!confirm("Delete?")) return;
  db.ref("stock").orderByChild("code").equalTo(code).once("value").then(s=>{
    const key = Object.keys(s.val())[0];
    db.ref("stock/"+key).remove();
  });
}


/* ================= DEFECT ================= */
function showDefect(){
  content.innerHTML=`
  <h2>Defect</h2>
  <div class="card">
    <label>Code</label>
    <input id="d_code">
    <label>Qty</label>
    <input id="d_qty" type="number">
    <button onclick="saveDefect()">Save Defect</button>
  </div>`;
}

function saveDefect(){
  const c=d_code.value.trim(),q=+d_qty.value;
  if(!c||!q) return alert("Required");

  db.ref("stock/"+c).once("value").then(s=>{
    if(!s.exists()||s.val().qty<q) return alert("Not enough stock");
    db.ref("stock/"+c+"/qty").set(s.val().qty-q);
    db.ref("defect").push({code:c,qty:q,date:new Date().toISOString()});
    alert("Defect saved");
  });
}

/* start */
showPurchase();
  function loadPurchase(){
  db.ref("purchase").once("value").then(s=>{
    purchaseList.innerHTML="";
    Object.values(s.val()||{}).forEach(r=>{
      purchaseList.innerHTML+=`
      <tr>
        <td>${r.date}</td>
        <td>${r.code}</td>
        <td>${r.name}</td>
        <td>${r.qty}</td>
        <td>${r.price}</td>
        <td>${r.total}</td>
      </tr>`;
    });
  });
}

function downloadPurchase(){
  db.ref("purchase").once("value").then(s=>{
    let csv="date,code,name,qty,price,total\n";
    Object.values(s.val()||{}).forEach(r=>{
      csv+=`${r.date},${r.code},${r.name},${r.qty},${r.price},${r.total}\n`;
    });
    const blob=new Blob([csv]);
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download="purchase.csv";
    a.click();
  });
}

</script>
</body>
</html>
