<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>HTORI ERP - STOCK BASIC</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

  <style>
    body { font-family: Arial; margin: 0; background:#f5f6f8; }
    header { background:#1f3c88; color:#fff; padding:12px; font-size:18px; }
    .wrap { padding:20px; max-width:900px; margin:auto; background:#fff; }
    h2 { margin-top:0; }
    input, button { width:100%; padding:8px; margin-bottom:8px; }
    table { width:100%; border-collapse:collapse; margin-top:20px; }
    th, td { border:1px solid #ccc; padding:8px; text-align:left; }
    th { background:#eee; }
    button { cursor:pointer; }
  </style>
</head>
<body>

<header>HTORI ERP – STOCK STEP 1</header>

<div class="wrap">

  <h2>Purchase (입고)</h2>

  <input type="date" id="p_date">
  <input type="text" id="p_code" placeholder="Code (예: A12)">
  <input type="text" id="p_name" placeholder="Name (예: Carton Box)">
  <input type="number" id="p_qty" placeholder="Qty">

  <button onclick="savePurchase()">Save Purchase</button>

  <h2>Stock</h2>

  <table>
    <thead>
      <tr>
        <th>Code</th>
        <th>Name</th>
        <th>Qty</th>
      </tr>
    </thead>
    <tbody id="stockBody"></tbody>
  </table>

</div>

<script>
/* =========================
   Firebase 설정 (확정)
========================= */
const firebaseConfig = {
  apiKey: "AIzaSyDwiTlPtoXraEtA7TzTctdH6DJS6gdSEGQ",
  authDomain: "htori-erp-38ed1.firebaseapp.com",
  databaseURL: "https://htori-erp-38ed1-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "htori-erp-38ed1",
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* =========================
   Purchase 저장 → Stock 누적
========================= */
function savePurchase() {
  const date = document.getElementById("p_date").value;
  const code = document.getElementById("p_code").value.trim();
  const name = document.getElementById("p_name").value.trim();
  const qty  = Number(document.getElementById("p_qty").value);

  if (!code || !qty) {
    alert("Code / Qty 필수");
    return;
  }

  // 1. 입고 기록 저장
  db.ref("purchase").push({
    date, code, name, qty
  });

  // 2. 재고 누적
  const stockRef = db.ref("stock/" + code);

  stockRef.once("value").then(snap => {
    let currentQty = 0;
    if (snap.exists()) {
      currentQty = snap.val().qty;
    }

    stockRef.set({
      code: code,
      name: name,
      qty: currentQty + qty
    });
  }).then(() => {
    alert("Saved");
    showStock();
  });
}

/* =========================
   Stock 불러오기
========================= */
function showStock() {
  const body = document.getElementById("stockBody");
  body.innerHTML = "";

  db.ref("stock").once("value").then(snapshot => {
    snapshot.forEach(child => {
      const s = child.val();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${s.code}</td>
        <td>${s.name}</td>
        <td>${s.qty}</td>
      `;
      body.appendChild(tr);
    });
  });
}

// 페이지 로드시 재고 표시
showStock();
</script>

</body>
</html>
