<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>HTORI ERP Payroll System</title>

<style>
body{font-family:Arial;background:#f4f6f9;margin:0}
header{background:#1f3c88;color:#fff;padding:12px 20px;font-size:18px}
.wrap{padding:20px;max-width:1380px}

h2{margin-top:30px}
input,select{padding:6px;margin:4px;width:200px}
button{padding:6px 14px;margin:4px;cursor:pointer}

table{border-collapse:collapse;width:100%;background:#fff;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px}
th{background:#eee}
tr:hover{background:#ffffcc;cursor:pointer}

.modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center}
.modal-box{background:#fff;padding:18px;border-radius:8px;width:360px}

</style>
</head>

<body>

<header>HTORI ERP – Employee & Payroll</header>

<div class="wrap">

<!-- 직원 UI -->
<h2>Employees</h2>

<input id="emp_id" placeholder="ID">
<input id="emp_name" placeholder="Name">
<input id="emp_birth" type="date">
<input id="emp_phone" placeholder="Phone">
<input id="emp_addr" placeholder="Address">
<select id="emp_rel">
 <option>Islam</option><option>Kristen</option><option>Buddha</option>
 <option>Hindu</option><option>Konghucu</option>
</select><br>

<select id="emp_type">
  <option value="PKWT">PKWT</option>
  <option value="PKWTT">PKWTT</option>
  <option value="Trainer">Trainer</option>
</select>

<select id="emp_salary_type">
  <option value="salary">Salary</option>
  <option value="hourly">Hourly</option>
  <option value="piece">Piece</option>
</select>

<input id="emp_salary_base" placeholder="Base Salary Rp">
<input id="emp_salary_hour" placeholder="Pay per Hour Rp">
<input id="emp_salary_piece" placeholder="Pay per Piece Rp">
<br>

<input id="emp_bank" placeholder="Bank Name">
<input id="emp_bank_acc" placeholder="Account No">
<input id="emp_tax" placeholder="Tax ID">
<input id="emp_join" type="date">
<input id="emp_memo" placeholder="Memo" style="width:300px"><br>

<button onclick="saveEmployee()">Save</button>
<button onclick="resetForm()">Reset</button>
<button onclick="resignEmployee()">Resign</button>
<button onclick="deleteEmployee()">Delete</button>

<table>
<thead><tr>
<th>ID</th><th>Name</th><th>Type</th><th>Salary Type</th><th>Bank</th>
</tr></thead>
<tbody id="empBody"></tbody>
</table>


<!-- 급여 -->
<h2>Payroll</h2>

<select id="pay_emp_select"></select>

<button onclick="downloadCSV()">Download CSV</button>
<button onclick="loadCalendar()">Refresh Calendar</button>
<button onclick="sumPayroll()">직원 급여 합계 보기</button>

<table>
<thead><tr><th>Date</th><th>Input</th><th>Daily Sum</th></tr></thead>
<tbody id="calBody"></tbody>
</table>

</div>

<!-- 급여 입력 모달 -->
<div id="payModal" class="modal" style="display:none">
 <div class="modal-box">
  <h3 id="pay_date"></h3>

  <label>Type</label><br>
  <select id="pay_type">
    <option value="salary">Salary</option>
    <option value="hourly">Hourly</option>
    <option value="piece">Piece</option>
  </select><br>

  <label>Salary Amount</label>
  <input id="pay_amount" type="number">
  
  <label>Hours</label>
  <input id="pay_hours" type="number">

  <label>Qty</label>
  <input id="pay_qty" type="number">

  <label>Unit Cost</label>
  <input id="pay_unit" type="number"><br>

  <button onclick="savePayroll()">Save</button>
  <button onclick="closePayModal()">Cancel</button>
 </div>
</div>


<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
// firebase init
firebase.initializeApp({
 apiKey:"AIzaSyARxh0wfAo2RMz_-3KsWUUQYfND_F3_3fI",
 authDomain:"htori-erp-38ed1.firebaseapp.com",
 databaseURL:"https://htori-erp-38ed1-default-rtdb.asia-southeast1.firebasedatabase.app",
 projectId:"htori-erp-38ed1"
});

const db=firebase.database();

let emp_status="active";

/* ====================== 직원 저장 ====================== */
function saveEmployee(){
 const obj={
   id:emp_id.value.trim(),
   name:emp_name.value.trim(),
   birth:emp_birth.value,
   phone:emp_phone.value,
   addr:emp_addr.value,
   religion:emp_rel.value,
   employment:emp_type.value,
   salaryType:emp_salary_type.value,
   baseSalary:+emp_salary_base.value.replace(/,/g,"")||0,
   payHour:+emp_salary_hour.value.replace(/,/g,"")||0,
   payPiece:+emp_salary_piece.value.replace(/,/g,"")||0,
   bank:emp_bank.value,
   bankAcc:emp_bank_acc.value,
   tax:emp_tax.value,
   join:emp_join.value,
   memo:emp_memo.value,
   status:emp_status
 }
 if(!obj.id) return alert("ID required")
 db.ref("employees/"+obj.id).set(obj).then(()=>{
  alert("Saved")
  resetForm()
  loadEmployees()
  loadEmployeeSelect()
 })
}

function resetForm(){
 document.querySelectorAll("input").forEach(e=>e.value="")
 emp_type.value="PKWT"
 emp_salary_type.value="salary"
 emp_status="active"
}

/* ====================== 직원 목록 ====================== */
function loadEmployees(){
 empBody.innerHTML=""
 db.ref("employees").once("value").then(s=>{
   s.forEach(r=>{
     const e=r.val()
     if(e.status==="resigned") return
    empBody.innerHTML+=`
       <tr>
         <td>${e.id}</td>
         <td>${e.name}</td>
         <td>${e.employment}</td>
         <td>${e.salaryType}</td>
         <td>${e.bank||""}</td>
         <td><button onclick="openEditModal('${e.id}')">수정</button></td>
         <th>Edit</th>
       </tr>`
   })
 })
}

/* ====================== 직원 수정 ====================== */
function editEmployee(id){
 db.ref("employees/"+id).once("value").then(s=>{
   const e=s.val()
   emp_id.value=e.id
   emp_name.value=e.name
   emp_birth.value=e.birth
   emp_phone.value=e.phone
   emp_addr.value=e.addr
   emp_rel.value=e.religion
   emp_type.value=e.employment
   emp_salary_type.value=e.salaryType
   emp_salary_base.value=e.baseSalary
   emp_salary_hour.value=e.payHour
   emp_salary_piece.value=e.payPiece
   emp_bank.value=e.bank
   emp_bank_acc.value=e.bankAcc
   emp_tax.value=e.tax
   emp_join.value=e.join
   emp_memo.value=e.memo
   emp_status=e.status
 })
}

/* ====================== 퇴사 처리 ====================== */
function resignEmployee(){
 if(!emp_id.value) return
 if(!confirm("퇴사 처리?")) return
 db.ref("employees/"+emp_id.value).update({
  status:"resigned",
  resignedDate:new Date().toISOString()
 }).then(()=>{
  alert("퇴사 완료")
  loadEmployees()
  loadEmployeeSelect()
 })
}

/* ====================== 직원 삭제 ====================== */
function deleteEmployee(){
 if(!emp_id.value) return
 if(!confirm("정말 삭제할까요? 기록 소실됨")) return
 db.ref("employees/"+emp_id.value).remove()
 .then(()=>{
   alert("삭제 완료")
   resetForm()
   loadEmployees()
   loadEmployeeSelect()
 })
}

/* ====================== 급여 ====================== */
function loadEmployeeSelect(){
 pay_emp_select.innerHTML="<option value=''>직원 선택</option>"
 db.ref("employees").once("value").then(s=>{
   s.forEach(r=>{
     const e=r.val()
     if(e.status==="resigned") return
     pay_emp_select.innerHTML+=`<option value="${e.id}">${e.id}-${e.name}</option>`
   })
 })
}

// 달력
function loadCalendar(){
 const y=new Date().getFullYear()
 const m=new Date().getMonth()+1
 const days=new Date(y,m,0).getDate()

 calBody.innerHTML=""
 for(let d=1; d<=days; d++){
   const date=`${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`
   calBody.innerHTML+=`
    <tr>
      <td>${date}</td>
      <td><button onclick="openPayModal('${date}')">입력</button></td>
      <td id="sum-${date}"></td>
    </tr>`
 }
 loadDailySum()
}

function rupiah(n){
 return "Rp "+Number(n||0).toLocaleString("id-ID")
}

function openPayModal(date){
 if(!pay_emp_select.value) return alert("직원 선택 필요")
 pay_date.innerText=date
 pay_amount.value=""
 pay_hours.value=""
 pay_qty.value=""
 pay_unit.value=""
 payModal.style.display="flex"
}

 function saveEditedEmployee(){
 const obj={
   id:edit_id.value.trim(),
   name:edit_name.value.trim(),
   phone:edit_phone.value.trim(),
   addr:edit_addr.value.trim(),
   birth:edit_birth.value,
   religion:edit_rel.value.trim(),
   join:edit_join.value,
   employment:edit_empType.value,
   salaryType:edit_salType.value,
   baseSalary:+edit_salBase.value||0,
   payHour:+edit_salHour.value||0,
   payPiece:+edit_salPiece.value||0,
   bank:edit_bank.value,
   bankAcc:edit_acc.value,
   tax:edit_tax.value,
   memo:edit_memo.value,
   status:"active"
 }

 db.ref("employees/"+currentEditId).set(obj).then(()=>{
   alert("수정 완료")
   closeEmpModal()
   loadEmployees()
   loadEmployeeSelect()
 })
}
function sumPayroll(){
 db.ref("payroll_log").once("value").then(s=>{
   const rows=s.val()||{}

   const sumPKWT=0, sumPKWTT=0, sumTrainer=0
   let tPKWT=0,tPKWTT=0,tTR=0

   Object.values(rows).forEach(r=>{
     const emp=r.employeeId
     if(!emp) return

     // 직원 정보 lookup
     db.ref("employees/"+emp).once("value").then(es=>{
       const e=es.val()
       if(!e) return

       if(e.employment==="PKWT") tPKWT+=r.amount
       if(e.employment==="PKWTT") tPKWTT+=r.amount
       if(e.employment==="Trainer") tTR+=r.amount

       showTotals(tPKWT,tPKWTT,tTR)
     })
   })
 })
}

// 표시 + csv 다운로드 제공
function showTotals(a,b,c){
 const div=document.createElement("div")
 div.innerHTML=`
   <h3>월별 합계</h3>
   PKWT: Rp ${a.toLocaleString('id-ID')}<br>
   PKWTT: Rp ${b.toLocaleString('id-ID')}<br>
   Trainer: Rp ${c.toLocaleString('id-ID')}<br>
   Total: Rp ${(a+b+c).toLocaleString('id-ID')}<br><br>
   <button onclick="downloadTotalCSV(${a},${b},${c})">CSV Download</button>
 `
 document.body.appendChild(div)
}

function downloadTotalCSV(a,b,c){
 let csv="PKWT,PKWTT,Trainer,Total\n"
 csv+=`${a},${b},${c},${a+b+c}`
 const blob=new Blob([csv],{type:"text/csv"})
 const aTag=document.createElement("a")
 aTag.href=URL.createObjectURL(blob)
 aTag.download="payrollTotal.csv"
 aTag.click()
}

function closePayModal(){
 payModal.style.display="none"
}

// 저장
function savePayroll(){
 const obj={
  employeeId:pay_emp_select.value,
  date:pay_date.innerText,
  type:pay_type.value,
  hours:+pay_hours.value||0,
  qty:+pay_qty.value||0,
  unitCost:+pay_unit.value||0,
  amount:+pay_amount.value||0,
  createdAt:new Date().toISOString()
 }

 if(obj.type==="hourly") obj.amount=obj.hours*obj.unitCost
 if(obj.type==="piece") obj.amount=obj.qty*obj.unitCost

 db.ref("payroll_log").push(obj).then(()=>{
  closePayModal()
  loadDailySum()
 })
}

// 일자별 합계
function loadDailySum(){
 db.ref("payroll_log").once("value").then(s=>{
   const rows=s.val()||{}
   const map={}
   Object.values(rows).forEach(r=>{
     const d=r.date
     map[d]=(map[d]||0)+(r.amount||0)
   })
   Object.keys(map).forEach(d=>{
     document.getElementById("sum-"+d).innerText=rupiah(map[d])
   })
 })
}


// CSV 다운로드
function downloadCSV(){
 db.ref("payroll_log").once("value").then(s=>{
   let csv="employee,date,type,amount\n"
   s.forEach(r=>{
     const v=r.val()
     csv+=`${v.employeeId},${v.date},${v.type},${v.amount}\n`
   })
   const blob=new Blob([csv],{type:"text/csv"})
   const a=document.createElement("a")
   a.href=URL.createObjectURL(blob)
   a.download="payroll.csv"
   a.click()
 })
}


loadEmployees()
loadEmployeeSelect()
loadCalendar()

</script>
<div id="empModal" class="modal" style="display:none">
 <div class="modal-box">
   <h3>직원 수정</h3>
   <div id="editEmpFields"></div>
   <button onclick="saveEditedEmployee()">저장</button>
   <button onclick="closeEmpModal()">취소</button>
 </div>
</div>
 
</body>
</html>
