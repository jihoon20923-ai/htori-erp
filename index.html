<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>HTORI ERP CORE – MENU + STOCK ENGINE</title>

<style>

body{margin:0;font-family:Arial;background:#f4f6f9}
header{background:#1f3c88;color:#fff;padding:12px 20px;font-size:18px}

.layout{display:flex;height:100vh}

/* LEFT MENU */
.sidebar{
  width:220px;
  background:#11151a;
  color:#fff;
  padding:14px;
}

.menu-btn{
  width:100%;
  padding:10px;
  margin-bottom:6px;
  background:#222;
  border:0;
  color:#fff;
  cursor:pointer;
  text-align:left;
  border-radius:4px;
}

.menu-btn:hover{background:#333}

.menu-btn.active{
  background:#1f3c88;
}

/* RIGHT CONTENT */
.content{
  flex:1;
  padding:20px;
  overflow-y:auto;
}

h2{margin-top:20px}

input,select,button{padding:6px;margin:4px;width:200px}

table{border-collapse:collapse;width:100%;background:#fff;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px}
th{background:#eee}

</style>

</head>
<body>

<header>HTORI ERP – STOCK ENGINE CORE</header>

<div class="layout">

<!-- LEFT MENU -->
<aside class="sidebar">

  <button class="menu-btn active" onclick="showPage('purchase')">Purchase</button>
  <button class="menu-btn" onclick="showPage('production')">Production</button>
  <button class="menu-btn" onclick="showPage('defect')">Defect</button>
  <button class="menu-btn" onclick="showPage('outsource')">Outsource</button>
  <button class="menu-btn" onclick="showPage('stock')">Stock</button>
  <button class="menu-btn" onclick="showPage('movement')">Stock Log</button>

</aside>


<!-- RIGHT CONTENT AREA -->
<main id="content" class="content">
</main>

</div>



<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>



<script>

firebase.initializeApp({
  apiKey:"AIzaSyARxh0wfAo2RMz_-3KsWUUQYfND_F3_3fI",
  authDomain:"htori-erp-38ed1.firebaseapp.com",
  databaseURL:"https://htori-erp-38ed1-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:"htori-erp-38ed1"
});

const db = firebase.database();




/* ===========================================================
   COMMON PAGE SWITCH
=========================================================== */
function showPage(key){

  /* activate menu button */
  document.querySelectorAll(".menu-btn").forEach(b=>b.classList.remove("active"));
  document.querySelector(`button[onclick="showPage('${key}')"]`).classList.add("active");

  if(key==="purchase") return renderPurchase();
  if(key==="production") return renderProduction();
  if(key==="defect") return renderDefect();
  if(key==="outsource") return renderOutsource();
  if(key==="stock") return renderStock();
  if(key==="movement") return renderMovement();

}


/* ===========================================================
   HTML_RENDER FUNCTIONS
=========================================================== */

function renderPurchase(){
  content.innerHTML = `
  <h2>Purchase 입고</h2>
  <input type="date" id="p_date">
  <input id="p_code" placeholder="Code">
  <input id="p_name" placeholder="Name">
  <input type="number" id="p_qty" placeholder="Qty">
  <button onclick="savePurchase()">Save</button>

  <table>
    <thead><tr><th>Date</th><th>Code</th><th>Name</th><th>Qty</th><th></th></tr></thead>
    <tbody id="purchaseBody"></tbody>
  </table>
  `;
  showPurchase();
}



function renderProduction(){
  content.innerHTML = `
  <h2>Production 공정</h2>

  <select id="prod_process">
    <option value="P01">P01</option>
    <option value="P02">P02</option>
  </select>

  <input id="prod_in" placeholder="Input Code">
  <input id="prod_out" placeholder="Output Code">
  <input type="number" id="prod_qty" placeholder="Qty">
  <button onclick="saveProduction()">Run</button>
  `;
}



function renderDefect(){
  content.innerHTML = `
  <h2>Defect 불량</h2>
  <input id="def_code" placeholder="Code">
  <input type="number" id="def_qty" placeholder="Qty">
  <button onclick="saveDefect()">Save</button>
  `;
}



function renderOutsource(){
  content.innerHTML = `
  <h2>Outsource 외주</h2>

  <select id="os_type">
    <option value="OUT">Send</option>
    <option value="IN">Receive</option>
  </select>

  <input id="os_vendor" placeholder="Vendor">
  <input id="os_code" placeholder="Code">
  <input type="number" id="os_qty" placeholder="Qty">
  <button onclick="saveOutsource()">Save</button>
  `;
}



function renderStock(){
  content.innerHTML = `
  <h2>Stock 현재 재고</h2>

  <button onclick="recalcAllStock()">전체 재계산</button>

  <table>
    <thead><tr><th style="width:120px">Code</th><th>Name</th><th>Qty</th></tr></thead>
    <tbody id="stockBody"></tbody>
  </table>
  `;
  showStock();
}



function renderMovement(){
  content.innerHTML = `
  <h2>Movement Log (재고 변동 내역)</h2>

  <table>
    <thead>
      <tr>
        <th>Date</th><th>Code</th><th>Qty</th><th>Type</th><th>Source</th><th>Vendor/Process</th>
      </tr>
    </thead>
    <tbody id="movementBody"></tbody>
  </table>
  `;

  showMovement();
}




/* =====================================================================================
     STOCK MOVEMENT ENGINE 아래는 기존동일 + 페이지 렌더링에 맞게 Target만 변경
===================================================================================== */

function addMovement(obj){
  const ref=db.ref("stock_movement").push();
  ref.set(obj).then(()=>recalcStock(obj.code));
}


function recalcStock(code){
  db.ref("stock_movement").orderByChild("code").equalTo(code)
  .once("value").then(s=>{
    let qty=0;
    s.forEach(c=>{
      const m=c.val();
      qty += (m.type==="IN"?m.qty:-m.qty);
    });
    db.ref("stock/"+code).update({code,qty});
    showStock();
  });
}


function savePurchase(){
  const date=p_date.value,code=p_code.value,name=p_name.value,qty=+p_qty.value;
  const ref=db.ref("purchase").push();
  ref.set({date,code,name,qty});
  addMovement({date,code,name,qty,type:"IN",source:"PURCHASE",refId:ref.key});
  showPurchase();
}


function showPurchase(){
  db.ref("purchase").once("value").then(s=>{
    purchaseBody.innerHTML="";
    s.forEach(c=>{
      const p=c.val();
      purchaseBody.innerHTML+=`
        <tr><td>${p.date}</td><td>${p.code}</td><td>${p.name}</td><td>${p.qty}</td>
        <td onclick="delPurchase('${c.key}','${p.code}')" style="color:red;cursor:pointer">삭제</td></tr>`;
    });
  });
}


function delPurchase(k,code){
  db.ref("purchase/"+k).remove();
  db.ref("stock_movement").orderByChild("refId").equalTo(k)
  .once("value").then(s=>{
    s.forEach(c=>c.ref.remove());
    recalcStock(code);
    showPurchase();
  });
}


function saveProduction(){
  const p=prod_process.value,inC=prod_in.value,outC=prod_out.value,qty=+prod_qty.value;
  addMovement({code:inC,qty,type:"OUT",source:"PRODUCTION",process:p});
  addMovement({code:outC,qty,type:"IN",source:"PRODUCTION",process:p});
}


function saveDefect(){
  addMovement({code:def_code.value,qty:+def_qty.value,type:"OUT",source:"DEFECT"});
}


function saveOutsource(){
  addMovement({
    code:os_code.value,
    qty:+os_qty.value,
    type:(os_type.value==="OUT"?"OUT":"IN"),
    source:"OUTSOURCE",
    vendor:os_vendor.value
  });
}


function showStock(){
  db.ref("stock").once("value").then(s=>{
    stockBody.innerHTML="";
    s.forEach(c=>{
      const v=c.val();
      stockBody.innerHTML+=`<tr><td>${v.code}</td><td></td><td>${v.qty}</td></tr>`;
    });
  });
}


function showMovement(){
  db.ref("stock_movement").limitToLast(200).once("value").then(s=>{
    movementBody.innerHTML="";
    s.forEach(c=>{
      const m=c.val();
      movementBody.innerHTML+=`
      <tr>
        <td>${m.date||""}</td>
        <td>${m.code}</td>
        <td>${m.qty}</td>
        <td>${m.type}</td>
        <td>${m.source}</td>
        <td>${m.vendor||m.process||""}</td>
      </tr>`;
    });
  });
}


function recalcAllStock(){
  db.ref("stock_movement").once("value").then(s=>{
    const sum={};
    s.forEach(c=>{
      const m=c.val();
      if(!sum[m.code]) sum[m.code]=0;
      sum[m.code]+= (m.type==="IN"?m.qty:-m.qty);
    });

    Object.keys(sum).forEach(code=>{
      db.ref("stock/"+code).update({code,qty:sum[code]});
    });

    showStock();
  });
}


showPage('purchase');

</script>

</body>
</html>
