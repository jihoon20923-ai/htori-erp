<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>HTORI ERP - STOCK CORE</title>

<style>
body{font-family:Arial;background:#f5f6f8;margin:0}
header{background:#1f3c88;color:#fff;padding:12px 20px;font-size:18px}
.wrap{padding:20px;max-width:1100px}
input,button{padding:8px;margin:4px 0;width:260px}
table{border-collapse:collapse;background:#fff;width:100%;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px}
th{background:#eee}
.danger{color:red;cursor:pointer}
</style>
</head>

<body>

<header>HTORI ERP – STOCK (Log Based)</header>

<div class="wrap">

<h2>Purchase (입고)</h2>
<input type="date" id="p_date"><br>
<input id="p_code" placeholder="Code (M001)"><br>
<input id="p_name" placeholder="Name"><br>
<input type="number" id="p_qty" placeholder="Qty"><br>
<button onclick="savePurchase()">Save Purchase</button>

<hr>

<h2>Purchase History</h2>
<table>
<thead>
<tr><th>Date</th><th>Code</th><th>Name</th><th>Qty</th><th>Action</th></tr>
</thead>
<tbody id="purchaseBody"></tbody>
</table>

<hr>

<h2>Stock (Calculated)</h2>
<table>
<thead>
<tr><th>Code</th><th>Name</th><th>Qty</th></tr>
</thead>
<tbody id="stockBody"></tbody>
</table>

</div>

<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
/* ================= Firebase ================= */
firebase.initializeApp({
  apiKey: "AIzaSyARxh0wfAo2RMz_-3KsWUUQYfND_F3_3fI",
  authDomain: "htori-erp-38ed1.firebaseapp.com",
  databaseURL: "https://htori-erp-38ed1-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "htori-erp-38ed1"
});
const db = firebase.database();

/* ================= Save Purchase ================= */
function savePurchase(){
  const date = p_date.value;
  const code = p_code.value.trim();
  const name = p_name.value.trim();
  const qty  = Number(p_qty.value);

  if(!date || !code || !qty){
    alert("Date / Code / Qty 필수");
    return;
  }

  // 1️⃣ Purchase 기록
  const pRef = db.ref("purchase").push();
  pRef.set({ date, code, name, qty });

  // 2️⃣ Stock Movement (IN)
  db.ref("stock_movement").push({
    date,
    code,
    name,
    qty,
    type: "IN",
    source: "PURCHASE",
    refId: pRef.key,
    createdAt: new Date().toISOString()
  });

  showPurchase();
  recalcStock(code);
}

/* ================= Delete Purchase ================= */
function delPurchase(key, code){
  if(!confirm("삭제?")) return;

  db.ref("purchase/"+key).remove();

  db.ref("stock_movement")
    .orderByChild("refId")
    .equalTo(key)
    .once("value")
    .then(snap=>{
      snap.forEach(c => c.ref.remove());
      recalcStock(code);
      showPurchase();
    });
}

/* ================= Recalculate Stock ================= */
function recalcStock(code){
  db.ref("stock_movement")
    .orderByChild("code")
    .equalTo(code)
    .once("value")
    .then(snap=>{
      let total = 0;
      let name = "";

      snap.forEach(c=>{
        const m = c.val();
        name = m.name || name;
        total += (m.type === "IN" ? m.qty : -m.qty);
      });

      db.ref("stock/"+code).set({
        code,
        name,
        qty: total
      });

      showStock();
    });
}

/* ================= Show Purchase ================= */
function showPurchase(){
  purchaseBody.innerHTML = "";
  db.ref("purchase").once("value").then(snap=>{
    snap.forEach(c=>{
      const p = c.val();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${p.date}</td>
        <td>${p.code}</td>
        <td>${p.name||""}</td>
        <td>${p.qty}</td>
        <td><span class="danger" onclick="delPurchase('${c.key}','${p.code}')">Del</span></td>
      `;
      purchaseBody.appendChild(tr);
    });
  });
}

/* ================= Show Stock ================= */
function showStock(){
  stockBody.innerHTML = "";
  db.ref("stock").once("value").then(snap=>{
    snap.forEach(c=>{
      const s = c.val();
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${s.code}</td><td>${s.name||""}</td><td>${s.qty}</td>`;
      stockBody.appendChild(tr);
    });
  });
}

/* ================= Init ================= */
showPurchase();
showStock();
</script>

</body>
</html>
