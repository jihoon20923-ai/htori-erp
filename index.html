<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>HTORI ERP CORE</title>

<style>
body{font-family:Arial;background:#f4f6f9;margin:0}
header{background:#1f3c88;color:#fff;padding:12px 20px;font-size:18px}
.wrap{padding:20px;max-width:1200px;margin:auto}
h2{margin-top:34px;font-size:20px;border-left:4px solid #1f3c88;padding-left:6px}
input,select,button{padding:6px;margin:4px}
table{border-collapse:collapse;width:100%;background:#fff;margin-top:10px}
th,td{border:1px solid #ccc;padding:6px;font-size:14px}
th{background:#eee}
button{cursor:pointer}
.danger{color:red}
.flex{display:flex;gap:12px}
</style>

</head>

<body>
<header>HTORI ERP – STOCK + EMPLOYEE + PAYROLL</header>

<div class="wrap">

<!-- ================================== PURCHASE =================================== -->
<h2>입고 (Purchase / Stock IN)</h2>
<div class="flex">
<input type="date" id="p_date">
<input id="p_code" placeholder="Code">
<input id="p_name" placeholder="Name">
<input type="number" id="p_qty" placeholder="Qty">
<button onclick="savePurchase()">Save</button>
</div>

<table>
<thead><tr><th>Date</th><th>Code</th><th>Name</th><th>Qty</th><th></th></tr></thead>
<tbody id="purchaseBody"></tbody>
</table>

<!-- ================================== DEFECT =================================== -->
<h2>불량 (Defect / Stock OUT)</h2>
<div class="flex">
<input id="def_code" placeholder="Code">
<input type="number" id="def_qty" placeholder="Qty">
<button onclick="saveDefect()">Save</button>
</div>

<!-- ================================== EMPLOYEES =================================== -->
<h2>직원 관리 (CRUD)</h2>
<div class="flex">
<input id="emp_id" placeholder="ID">
<input id="emp_name" placeholder="Name">
<select id="emp_employment">
  <option>PKWT</option>
  <option>PKWTT</option>
  <option>TRAINER</option>
</select>
<input id="emp_bank" placeholder="Bank">
<input id="emp_tax" placeholder="Tax No">
<button onclick="saveEmployee()">Add</button>
</div>

<div id="empEditArea"></div>

<table>
<thead><tr><th>ID</th><th>Name</th><th>Type</th><th>Bank</th><th>Tax</th><th></th></tr></thead>
<tbody id="empBody"></tbody>
</table>

<!-- ================================== PAYROLL =================================== -->
<h2>급여 계산</h2>

<label>급여 월 선택</label>
<br>
<input type="month" id="pay_month">

<h3>급여 대상 직원 선택</h3>
<div id="payEmpList"></div>

<button onclick="calcPayroll()">선택 직원 급여 합계</button>

<div id="payResult" style="margin-top:20px"></div>

<!-- ================================== STOCK =================================== -->
<h2>현재 재고</h2>
<table>
<thead><tr><th>Code</th><th>Name</th><th>Qty</th></tr></thead>
<tbody id="stockBody"></tbody>
</table>

</div>


<!-- Firebase v8 -->
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

<script>
// ================= 1) Firebase 연결 =================
firebase.initializeApp({
  apiKey:"AIzaSyARxh0wfAo2RMz_-3KsWUUQYfND_F3_3fI",
  authDomain:"htori-erp-38ed1.firebaseapp.com",
  databaseURL:"https://htori-erp-38ed1-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:"htori-erp-38ed1"
});
const db=firebase.database();


// ================== 공통: movement push + 재고 재계산 ==================
function addMovement(obj){
  db.ref("stock_movement").push(obj).then(()=>recalc(obj.code))
}

function recalc(code){
  db.ref("stock_movement").orderByChild("code").equalTo(code).once("value")
  .then(s=>{
    let qty=0,name=""
    s.forEach(c=>{
      const m=c.val()
      name=m.name||name
      qty += (m.type==="IN"?m.qty:-m.qty)
    })
    db.ref("stock/"+code).set({code,name,qty})
    loadStock()
  })
}


// ================== 2) PURCHASE ==================
function savePurchase(){
  const date=p_date.value,code=p_code.value,name=p_name.value,qty=+p_qty.value
  const ref=db.ref("purchase").push()
  ref.set({date,code,name,qty})
  addMovement({date,code,name,qty,type:"IN",source:"PURCHASE",refId:ref.key})
  loadPurchase()
}

function loadPurchase(){
  purchaseBody.innerHTML=""
  db.ref("purchase").once("value").then(s=>{
    s.forEach(c=>{
      const v=c.val()
      purchaseBody.innerHTML+=`
      <tr>
      <td>${v.date}</td><td>${v.code}</td><td>${v.name}</td><td>${v.qty}</td>
      <td class="danger" onclick="delPurchase('${c.key}','${v.code}')">Del</td>
      </tr>`
    })
  })
}

function delPurchase(key,code){
  db.ref("purchase/"+key).remove()
  db.ref("stock_movement").orderByChild("refId").equalTo(key).once("value").then(s=>{
    s.forEach(c=>c.ref.remove())
    recalc(code)
    loadPurchase()
  })
}


// ================== 3) DEFECT ==================
function saveDefect(){
  addMovement({code:def_code.value,qty:+def_qty.value,type:"OUT",source:"DEFECT"})
}


// ================== 4-1) 직원 등록 ==================
function saveEmployee(){
  const obj={
    id:emp_id.value,
    name:emp_name.value,
    employment:emp_employment.value,
    bank:emp_bank.value,
    tax:emp_tax.value
  }
  db.ref("employees").push(obj).then(()=>{
    loadEmployees()
  })
}

function loadEmployees(){
  empBody.innerHTML=""
  db.ref("employees").once("value").then(s=>{
    const list=s.val()||{}
    Object.keys(list).forEach(key=>{
      const e=list[key]
      empBody.innerHTML+=`
      <tr>
      <td>${e.id}</td>
      <td>${e.name}</td>
      <td>${e.employment}</td>
      <td>${e.bank}</td>
      <td>${e.tax}</td>
      <td>
       <button onclick="openEdit('${key}')">수정</button>
       <button class="danger" onclick="delEmp('${key}')">삭제</button>
      </td>
      </tr>`
    })
    loadPayrollEmployees()
  })
}


// ================== 4-2) 직원 수정 ==================
function openEdit(key){
  db.ref("employees/"+key).once("value").then(s=>{
    const e=s.val()
    empEditArea.innerHTML=`
    <h3>직원 수정</h3>
    <input id="edit_id" value="${e.id}">
    <input id="edit_name" value="${e.name}">
    <select id="edit_employment">
     <option ${e.employment==="PKWT"?"selected":""}>PKWT</option>
     <option ${e.employment==="PKWTT"?"selected":""}>PKWTT</option>
     <option ${e.employment==="TRAINER"?"selected":""}>TRAINER</option>
    </select>
    <input id="edit_bank" value="${e.bank}">
    <input id="edit_tax" value="${e.tax}">
    <button onclick="saveEdit('${key}')">저장</button>
    `
  })
}

function saveEdit(key){
  const obj={
    id:edit_id.value,
    name:edit_name.value,
    employment:edit_employment.value,
    bank:edit_bank.value,
    tax:edit_tax.value
  }
  db.ref("employees/"+key).update(obj).then(()=>{
    empEditArea.innerHTML=""
    loadEmployees()
  })
}

function delEmp(key){
  if(confirm("삭제?")){
    db.ref("employees/"+key).remove().then(loadEmployees)
  }
}


// ================== 5) payroll 직원 목록 로드 ==================
function loadPayrollEmployees(){
  payEmpList.innerHTML=""
  db.ref("employees").once("value").then(s=>{
    const list=s.val()||{}
    Object.keys(list).forEach(key=>{
      const e=list[key]
      payEmpList.innerHTML+=`
        <label>
         <input type="checkbox" class="pay-emp" value="${key}"> 
         ${e.name} (${e.employment})
        </label><br>`
    })
  })
}


// ================== 6) payroll 합계 ==================
function calcPayroll(){
  const month=pay_month.value
  if(!month) return alert("월을 선택")

  const ids=Array.from(document.querySelectorAll(".pay-emp:checked")).map(x=>x.value)
  if(ids.length===0) return alert("직원 선택")

  const start=month+"-01"
  const end=month+"-31"

  db.ref("payroll_log").once("value").then(s=>{
    const logs=s.val()||{}
    const total={}
    ids.forEach(id=>total[id]=0)

    Object.values(logs).forEach(r=>{
      if(ids.includes(r.employeeId)){
        if(r.date>=start && r.date<=end){
          total[r.employeeId]+=Number(r.amount||0)
        }
      }
    })

    showPayroll(total)
  })
}

function showPayroll(result){
  payResult.innerHTML=""
  Object.keys(result).forEach(id=>{
    db.ref("employees/"+id).once("value").then(s=>{
      const e=s.val()
      const amt=result[id]
      payResult.innerHTML+=`${e.name} (${e.employment}) : Rp ${amt.toLocaleString("id-ID")}<br>`
    })
  })
}


// ================== 7) 재고 표시 ==================
function loadStock(){
  stockBody.innerHTML=""
  db.ref("stock").once("value").then(s=>{
    s.forEach(x=>{
      const v=x.val()
      stockBody.innerHTML+=`<tr><td>${v.code}</td><td>${v.name}</td><td>${v.qty}</td></tr>`
    })
  })
}


// ================= INIT =================
loadPurchase()
loadEmployees()
loadStock()
loadPayrollEmployees()

</script>

</body>
</html>
